@* MetricCard.razor — Vital sign display card with sparkline and trend indicator *@

<MudCard Elevation="0" Class="glass-card">
    <MudCardContent>
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <MudText Typo="Typo.caption" Style="color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">
                    @Title
                </MudText>
                <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 8px;">
                    <MudText Typo="Typo.h3" Style="@ValueStyle">
                        @FormattedValue
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: var(--text-sec);">
                        @Unit
                    </MudText>
                </div>
            </div>
            <div style="font-size: 2rem; opacity: 0.6;">@Icon</div>
        </div>

        @if (SparklineData.Count > 1)
        {
            <div style="margin-top: 16px; height: 40px;">
                <svg viewBox="0 0 @(SparklineData.Count * 10) 40" style="width: 100%; height: 100%;" preserveAspectRatio="none">
                    <polyline
                        points="@GetSparklinePath()"
                        fill="none"
                        stroke="@SparklineColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
        }

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px;">
            <div style="display: flex; align-items: center; gap: 4px;">
                <MudIcon Icon="@TrendIcon" Size="Size.Small" Style="@TrendStyle" />
                <MudText Typo="Typo.caption" Style="@TrendStyle">@TrendLabel</MudText>
            </div>
            <MudText Typo="Typo.caption" Style="color: var(--text-tert);">
                @(LastUpdated == default ? "—" : LastUpdated.ToString("HH:mm:ss"))
            </MudText>
        </div>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public string Title { get; set; } = "Metric";
    [Parameter] public string Icon { get; set; } = "❤️";
    [Parameter] public double Value { get; set; }
    [Parameter] public string Unit { get; set; } = "";
    [Parameter] public int Decimals { get; set; } = 0;
    [Parameter] public TrendDirection Trend { get; set; } = TrendDirection.Stable;
    [Parameter] public List<double> SparklineData { get; set; } = [];
    [Parameter] public DateTime LastUpdated { get; set; }
    [Parameter] public string AccentColor { get; set; } = "#00D4C8";

    public enum TrendDirection { Up, Down, Stable }

    private string FormattedValue => Value.ToString($"F{Decimals}");
    private string ValueStyle => $"font-weight: 300; color: {AccentColor}; font-size: 2.2rem; line-height: 1; font-family: var(--font-rounded);";
    private string SparklineColor => AccentColor;

    private string TrendIcon => Trend switch
    {
        TrendDirection.Up => Icons.Material.Filled.TrendingUp,
        TrendDirection.Down => Icons.Material.Filled.TrendingDown,
        _ => Icons.Material.Filled.TrendingFlat
    };

    private string TrendStyle => Trend switch
    {
        TrendDirection.Up => "color: var(--green-positive);",
        TrendDirection.Down => "color: var(--red-critical);",
        _ => "color: var(--text-sec);"
    };

    private string TrendLabel => Trend switch
    {
        TrendDirection.Up => "Rising",
        TrendDirection.Down => "Falling",
        _ => "Stable"
    };

    private string GetSparklinePath()
    {
        if (SparklineData.Count < 2) return "";

        var min = SparklineData.Min();
        var max = SparklineData.Max();
        var range = max - min;
        if (range == 0) range = 1;

        var points = SparklineData.Select((val, i) =>
        {
            var x = i * 10;
            var y = 38 - (val - min) / range * 36;
            return $"{x},{y:F1}";
        });

        return string.Join(" ", points);
    }
}
