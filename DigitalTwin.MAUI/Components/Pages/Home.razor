@page "/"
@page "/home"
@implements IDisposable
@inject IVitalsApplicationService VitalsService
@inject IEnvironmentApplicationService EnvironmentService
@inject IHealthDataSyncService SyncService
@inject IAuthApplicationService AuthService

<RequireAuth>
<div>
    <MudText Typo="Typo.h5" Style="color: #e2e8f0; font-weight: 700; margin-bottom: 24px;">
        Digital Twin Dashboard
    </MudText>

    <MudGrid Spacing="3">
        @* Digital Twin Mannequin *@
        <MudItem xs="12" sm="4">
            <DigitalTwinMannequin
                HeartRateValue="@_heartRate"
                OxygenValue="@_spo2"
                StepsValue="@_steps" />
        </MudItem>

        @* Vital Sign Cards *@
        <MudItem xs="12" sm="8">
            <MudGrid Spacing="3">
                <MudItem xs="6">
                    <MetricCard
                        Title="Heart Rate"
                        Icon="â¤ï¸"
                        Value="@_heartRate"
                        Unit="bpm"
                        Decimals="0"
                        Trend="@GetTrend(_hrTrend)"
                        SparklineData="@_hrHistory"
                        LastUpdated="@_lastUpdated"
                        AccentColor="#E91E63" />
                </MudItem>
                <MudItem xs="6">
                    <MetricCard
                        Title="SpO2"
                        Icon="ðŸ«"
                        Value="@_spo2"
                        Unit="%"
                        Decimals="1"
                        Trend="@GetTrend(_spo2Trend)"
                        SparklineData="@_spo2History"
                        LastUpdated="@_lastUpdated"
                        AccentColor="#60a5fa" />
                </MudItem>
                <MudItem xs="6">
                    <MetricCard
                        Title="Steps"
                        Icon="ðŸš¶"
                        Value="@_steps"
                        Unit="steps"
                        Decimals="0"
                        Trend="@GetTrend(_stepsTrend)"
                        SparklineData="@_stepsHistory"
                        LastUpdated="@_lastUpdated"
                        AccentColor="#4ade80" />
                </MudItem>
                <MudItem xs="6">
                    <MetricCard
                        Title="Calories"
                        Icon="ðŸ”¥"
                        Value="@_calories"
                        Unit="kcal"
                        Decimals="0"
                        Trend="@GetTrend(_caloriesTrend)"
                        SparklineData="@_caloriesHistory"
                        LastUpdated="@_lastUpdated"
                        AccentColor="#fbbf24" />
                </MudItem>
            </MudGrid>
        </MudItem>

        @* Environment Widget *@
        <MudItem xs="12">
            <MudCard Style="background: linear-gradient(145deg, rgba(26, 31, 46, 0.9), rgba(15, 20, 35, 0.95)); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 16px;" Elevation="0">
                <MudCardContent>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <MudText Typo="Typo.subtitle1" Style="color: #e2e8f0; font-weight: 600;">
                            Environment
                        </MudText>
                        @if (_envReading is not null)
                        {
                            <EnvironmentBadge Level="@_envReading.AirQuality" />
                        }
                    </div>
                    @if (_envReading is not null)
                    {
                        <MudGrid Spacing="3">
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Style="color: #64748b; text-transform: uppercase; letter-spacing: 0.1em;">Temperature</MudText>
                                <MudText Typo="Typo.h6" Style="color: #fbbf24;">@_envReading.Temperature.ToString("F1")Â°C</MudText>
                            </MudItem>
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Style="color: #64748b; text-transform: uppercase; letter-spacing: 0.1em;">Humidity</MudText>
                                <MudText Typo="Typo.h6" Style="color: #60a5fa;">@_envReading.Humidity.ToString("F1")%</MudText>
                            </MudItem>
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Style="color: #64748b; text-transform: uppercase; letter-spacing: 0.1em;">PM2.5</MudText>
                                <MudText Typo="Typo.h6" Style="@($"color: {Pm25Color};")">@_envReading.PM25.ToString("F1") Âµg/mÂ³</MudText>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</div>
</RequireAuth>

@code {
    private IDisposable? _vitalsSubscription;
    private IDisposable? _envSubscription;

    private double _heartRate;
    private double _spo2;
    private double _steps;
    private double _calories;
    private DateTime _lastUpdated;

    private int _hrTrend;
    private int _spo2Trend;
    private int _stepsTrend;
    private int _caloriesTrend;

    private readonly List<double> _hrHistory = [];
    private readonly List<double> _spo2History = [];
    private readonly List<double> _stepsHistory = [];
    private readonly List<double> _caloriesHistory = [];

    private EnvironmentReadingDto? _envReading;

    private string Pm25Color => _envReading?.AirQuality switch
    {
        AirQualityLevel.Good => "#4ade80",
        AirQualityLevel.Moderate => "#fbbf24",
        AirQualityLevel.Unhealthy => "#f87171",
        _ => "#94a3b8"
    };

    protected override async Task OnInitializedAsync()
    {
        await SyncService.StartSyncAsync();

        _vitalsSubscription = VitalsService.GetLiveVitals()
            .Subscribe(dto =>
            {
                switch (dto.Type)
                {
                    case VitalSignType.HeartRate:
                        _heartRate = dto.Value;
                        _hrTrend = dto.Trend;
                        AddToHistory(_hrHistory, dto.Value);
                        break;
                    case VitalSignType.SpO2:
                        _spo2 = dto.Value;
                        _spo2Trend = dto.Trend;
                        AddToHistory(_spo2History, dto.Value);
                        break;
                    case VitalSignType.Steps:
                        _steps = dto.Value;
                        _stepsTrend = dto.Trend;
                        AddToHistory(_stepsHistory, dto.Value);
                        break;
                    case VitalSignType.Calories:
                        _calories = dto.Value;
                        _caloriesTrend = dto.Trend;
                        AddToHistory(_caloriesHistory, dto.Value);
                        break;
                }

                _lastUpdated = dto.Timestamp;
                InvokeAsync(StateHasChanged);
            });

        try
        {
            _envReading = await EnvironmentService.GetCurrentEnvironmentAsync();
        }
        catch
        {
            // Will be populated by subscription
        }

        _envSubscription = EnvironmentService.SubscribeToEnvironment()
            .Subscribe(dto =>
            {
                _envReading = dto;
                InvokeAsync(StateHasChanged);
            });
    }

    private static void AddToHistory(List<double> history, double value)
    {
        history.Add(value);
        if (history.Count > 20)
            history.RemoveAt(0);
    }

    private static MetricCard.TrendDirection GetTrend(int trend) => trend switch
    {
        > 0 => MetricCard.TrendDirection.Up,
        < 0 => MetricCard.TrendDirection.Down,
        _ => MetricCard.TrendDirection.Stable
    };

    public void Dispose()
    {
        _vitalsSubscription?.Dispose();
        _envSubscription?.Dispose();
    }
}
