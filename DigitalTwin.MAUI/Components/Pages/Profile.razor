@page "/profile"
@inject IAuthApplicationService AuthService
@inject IHealthDataSyncService SyncService
@inject NavigationManager Navigation

<RequireAuth>
    <div class="page-enter" style="display: flex; flex-direction: column; gap: 16px; max-width: 600px; margin: 0 auto;">

        @if (_currentUser is not null)
        {
            <ProfileHeader DisplayName="@_currentUser.DisplayName"
                           Email="@_currentUser.Email"
                           PhotoUrl="@_currentUser.PhotoUrl"
                           UserId="@_currentUser.UserId"
                           HasPatientProfile="@_currentUser.HasPatientProfile" />

            @if (!_showForm)
            {
                <PatientProfileCard Patient="@_patient"
                                    OnCreateClicked="ShowCreateForm"
                                    OnEditClicked="ShowEditForm" />
            }
            else
            {
                <PatientProfileForm IsEditing="@(_patient is not null)"
                                    IsSaving="@_isSaving"
                                    ErrorMessage="@_formError"
                                    InitialBloodType="@_patient?.BloodType"
                                    InitialAllergies="@_patient?.Allergies"
                                    InitialMedicalHistory="@_patient?.MedicalHistoryNotes"
                                    OnSave="SaveProfileAsync"
                                    OnCancel="CancelForm" />
            }

            <ProfileCompletionChecklist Items="@_checklistItems" />

            @* ── Sign Out ──────────────────────────────────────────────── *@
            <MudCard Class="glass-card" Elevation="0">
                <MudCardContent>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               FullWidth="true"
                               OnClick="SignOutAsync"
                               Style="text-transform: none; font-weight: 600;">
                        Log out
                    </MudButton>
                </MudCardContent>
            </MudCard>
        }
    </div>
</RequireAuth>

@code {
    private AuthResultDto? _currentUser;
    private PatientDisplayDto? _patient;
    private bool _showForm;
    private bool _isSaving;
    private string? _formError;
    private List<ProfileCompletionChecklist.ChecklistItem> _checklistItems = new();

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser is not null)
        {
            _patient = await AuthService.GetPatientProfileAsync();
        }
        RebuildChecklist();
    }

    private void ShowCreateForm()
    {
        _formError = null;
        _showForm = true;
    }

    private void ShowEditForm()
    {
        _formError = null;
        _showForm = true;
    }

    private void CancelForm()
    {
        _showForm = false;
        _formError = null;
    }

    private async Task SaveProfileAsync(PatientProfileDto profile)
    {
        _isSaving = true;
        _formError = null;

        try
        {
            _currentUser = await AuthService.CreatePatientProfileAsync(profile);
            _patient = await AuthService.GetPatientProfileAsync();
            await SyncService.StartVitalsCollectionAsync();
            _showForm = false;
            RebuildChecklist();
        }
        catch (Exception ex)
        {
            _formError = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task SignOutAsync()
    {
        SyncService.StopSync();
        await AuthService.SignOutAsync();
        _currentUser = null;
        _patient = null;
        Navigation.NavigateTo("/login");
    }

    private void RebuildChecklist()
    {
        _checklistItems = new List<ProfileCompletionChecklist.ChecklistItem>
        {
            new(true, "Personal info"),
            new(_currentUser?.HasPatientProfile == true, "Medical profile"),
            new(!string.IsNullOrEmpty(_patient?.BloodType), "Blood type"),
            new(!string.IsNullOrEmpty(_patient?.Allergies), "Allergies info"),
            new(!string.IsNullOrEmpty(_patient?.MedicalHistoryNotes), "Medical history")
        };
    }
}
