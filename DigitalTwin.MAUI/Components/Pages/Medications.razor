@page "/medications"
@inject IMedicationApplicationService MedicationService
@inject ISnackbar Snackbar

<RequireAuth>
    <div class="page-enter" style="display: flex; flex-direction: column; gap: 16px;">

        <MudCard Class="glass-card" Elevation="0">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Style="color: var(--text-main); font-weight: 600; margin-bottom: 16px;">
                    Check Drug Interactions
                </MudText>
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_rxCuiInput"
                                  Label="RxCUI codes (comma-separated)"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Medication"
                                  Placeholder="e.g. 207106, 152923" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="CheckInteractionsAsync"
                               Disabled="_isLoading"
                               StartIcon="@(_isLoading ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Search)"
                               Style="text-transform: none;">
                        @(_isLoading ? "Checking..." : "Check Interactions")
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>

        @if (_interactions.Any())
        {
            <MudCard Class="glass-card" Elevation="0" Style="overflow: hidden;">
                <MudTable Items="@_interactions"
                          Hover="true"
                          Breakpoint="Breakpoint.Sm"
                          Dense="true"
                          Elevation="0"
                          Style="background: transparent;">
                    <HeaderContent>
                        <MudTh Style="color: var(--text-sec);">Drug A</MudTh>
                        <MudTh Style="color: var(--text-sec);">Drug B</MudTh>
                        <MudTh Style="color: var(--text-sec);">Severity</MudTh>
                        <MudTh Style="color: var(--text-sec);">Description</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Drug A" Style="color: var(--text-main);">@context.DrugARxCui</MudTd>
                        <MudTd DataLabel="Drug B" Style="color: var(--text-main);">@context.DrugBRxCui</MudTd>
                        <MudTd DataLabel="Severity">
                            <MedicationSafetyBadge Severity="@context.Severity" />
                        </MudTd>
                        <MudTd DataLabel="Description" Style="color: var(--text-sec); max-width: 300px;">
                            @context.Description
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCard>
        }
        else if (_hasSearched && !_isLoading)
        {
            <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Style="margin-top: 8px;">
                No interactions found between the specified medications.
            </MudAlert>
        }
    </div>
</RequireAuth>

@code {
    private string _rxCuiInput = string.Empty;
    private bool _isLoading;
    private bool _hasSearched;
    private List<MedicationInteractionDto> _interactions = [];

    private async Task CheckInteractionsAsync()
    {
        if (string.IsNullOrWhiteSpace(_rxCuiInput)) return;

        _isLoading = true;
        _hasSearched = true;

        try
        {
            var rxCuis = _rxCuiInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();

            if (rxCuis.Count < 2)
            {
                Snackbar.Add("Please enter at least two RxCUI codes.", Severity.Warning);
                return;
            }

            var results = await MedicationService.CheckInteractionsAsync(rxCuis);
            _interactions = results.ToList();

            if (_interactions.Any(i => i.Severity == InteractionSeverity.High))
                Snackbar.Add("High-risk interactions detected!", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
